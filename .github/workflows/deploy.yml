name: Deploy to AWS App Runner

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION:      ap-northeast-1
  ECR_REPOSITORY:  tenasia-intelligence-hub

jobs:
  # ────────────────────────────────────────────────────
  # Job 1: 테스트
  # ────────────────────────────────────────────────────
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run tests
        run: python -m pytest test_*.py -v --tb=short
        # 테스트가 없을 때 오류 방지
        continue-on-error: true

  # ────────────────────────────────────────────────────
  # Job 2: Docker 빌드 & ECR Push
  # ────────────────────────────────────────────────────
  build:
    name: Build & Push
    runs-on: ubuntu-latest
    needs: test

    permissions:
      id-token: write   # OIDC 토큰 (AWS 인증 — 비밀번호 불필요)
      contents: read

    outputs:
      image-uri: ${{ steps.push.outputs.image-uri }}

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build & Push image
        id: push
        env:
          REGISTRY:  ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
            --build-arg GIT_COMMIT="${{ github.sha }}" \
            -t "$REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" \
            -t "$REGISTRY/$ECR_REPOSITORY:latest" \
            .

          docker push "$REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          docker push "$REGISTRY/$ECR_REPOSITORY:latest"

          echo "image-uri=$REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> "$GITHUB_OUTPUT"

  # ────────────────────────────────────────────────────
  # Job 3: App Runner 배포
  # ────────────────────────────────────────────────────
  deploy:
    name: Deploy App Runner
    runs-on: ubuntu-latest
    needs: build

    permissions:
      id-token: write
      contents: read

    environment:
      name: production
      url: ${{ steps.url.outputs.value }}

    steps:
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy (start-deployment or recreate if needed)
        id: deploy
        env:
          IMAGE_URI:       ${{ needs.build.outputs.image-uri }}
          DATABASE_URL:    ${{ secrets.DATABASE_URL }}
          GEMINI_API_KEY:  ${{ secrets.GEMINI_API_KEY }}
        run: |
          set -euo pipefail

          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_ROLE="arn:aws:iam::${ACCOUNT_ID}:role/AppRunnerECRAccessRole"
          SERVICE_NAME="tenasia-intelligence-hub"

          # 서비스 ARN을 이름으로 동적 조회 (Secret 의존성 제거)
          SERVICE_ARN=$(aws apprunner list-services \
            --query "ServiceSummaryList[?ServiceName=='${SERVICE_NAME}'].ServiceArn | [0]" \
            --output text 2>/dev/null || true)

          if [ -z "$SERVICE_ARN" ] || [ "$SERVICE_ARN" = "None" ]; then
            STATUS="NOT_FOUND"
          else
            STATUS=$(aws apprunner describe-service \
              --service-arn "$SERVICE_ARN" \
              --query 'Service.Status' --output text 2>/dev/null || echo "NOT_FOUND")
          fi
          echo "현재 서비스 상태: $STATUS (ARN: ${SERVICE_ARN:-없음})"

          if [ "$STATUS" = "RUNNING" ]; then
            # ── 정상 상태: 환경 변수 업데이트 후 배포 트리거 ────
            aws apprunner update-service \
              --service-arn "$SERVICE_ARN" \
              --source-configuration "{
                \"ImageRepository\": {
                  \"ImageIdentifier\": \"$IMAGE_URI\",
                  \"ImageConfiguration\": {
                    \"Port\": \"8000\",
                    \"RuntimeEnvironmentVariables\": {
                      \"DATABASE_URL\": \"$DATABASE_URL\",
                      \"GEMINI_API_KEY\": \"$GEMINI_API_KEY\"
                    }
                  },
                  \"ImageRepositoryType\": \"ECR\"
                },
                \"AuthenticationConfiguration\": {\"AccessRoleArn\": \"$ECR_ROLE\"},
                \"AutoDeploymentsEnabled\": false
              }"
            echo "서비스 업데이트 완료"
            echo "service-arn=$SERVICE_ARN" >> "$GITHUB_OUTPUT"

          else
            # ── 비정상/미존재: 삭제 후 재생성 ────────────────────
            echo "서비스 비정상 상태($STATUS) → 삭제 후 재생성 진행"

            # 기존 서비스 삭제 (없거나 이미 삭제 중이면 무시)
            if [ "$STATUS" != "NOT_FOUND" ] && [ "$STATUS" != "DELETED" ]; then
              echo "서비스 삭제 요청..."
              aws apprunner delete-service --service-arn "$SERVICE_ARN" || true
            fi

            # 서비스 이름이 list-services에서 사라질 때까지 대기 (최대 10분)
            # describe-service는 삭제 중에도 에러를 반환해 조기 탈출하는 문제가 있으므로
            # list-services로 이름 소멸 여부를 확인합니다.
            echo "서비스 이름 해제 대기 중 (최대 10분)..."
            for i in $(seq 1 30); do
              FOUND=$(aws apprunner list-services \
                --query "ServiceSummaryList[?ServiceName=='${SERVICE_NAME}'].ServiceName | [0]" \
                --output text 2>/dev/null || echo "")
              echo "  [삭제 대기 $i/30] 잔존: ${FOUND:-없음}"
              if [ -z "$FOUND" ] || [ "$FOUND" = "None" ]; then
                echo "  서비스 이름 해제 확인"
                break
              fi
              sleep 20
            done

            # 소스 설정 JSON 파일 생성 (jq로 특수문자 안전 처리)
            jq -n \
              --arg image  "$IMAGE_URI" \
              --arg db     "$DATABASE_URL" \
              --arg gemini "$GEMINI_API_KEY" \
              --arg role   "$ECR_ROLE" \
              '{
                ImageRepository: {
                  ImageIdentifier: $image,
                  ImageConfiguration: {
                    Port: "8000",
                    RuntimeEnvironmentVariables: {
                      DATABASE_URL:   $db,
                      GEMINI_API_KEY: $gemini
                    }
                  },
                  ImageRepositoryType: "ECR"
                },
                AuthenticationConfiguration: {AccessRoleArn: $role},
                AutoDeploymentsEnabled: false
              }' > /tmp/source-config.json
            echo "source-config.json 생성 완료"

            # 새 서비스 생성 (이름 충돌 시 최대 3회 재시도)
            echo "새 서비스 생성 중: $SERVICE_NAME"
            NEW_ARN=""
            for attempt in 1 2 3; do
              NEW_ARN=$(aws apprunner create-service \
                --service-name "$SERVICE_NAME" \
                --source-configuration file:///tmp/source-config.json \
                --instance-configuration '{"Cpu":"1 vCPU","Memory":"2 GB"}' \
                --health-check-configuration \
                  '{"Protocol":"HTTP","Path":"/health","Interval":10,"Timeout":5,"HealthyThreshold":1,"UnhealthyThreshold":5}' \
                --query 'Service.ServiceArn' --output text 2>&1) && break
              echo "  [생성 시도 $attempt/3] 실패: $NEW_ARN — 30초 후 재시도"
              sleep 30
            done

            if [[ "$NEW_ARN" != arn:* ]]; then
              echo "서비스 생성 최종 실패: $NEW_ARN"
              exit 1
            fi

            echo "새 서비스 ARN: $NEW_ARN"
            echo "service-arn=$NEW_ARN" >> "$GITHUB_OUTPUT"
          fi

      - name: Wait for deployment
        run: |
          ARN="${{ steps.deploy.outputs.service-arn }}"
          echo "배포 완료 대기 중 (최대 15분)..."
          for i in $(seq 1 30); do
            STATUS=$(aws apprunner describe-service \
              --service-arn "$ARN" \
              --query 'Service.Status' --output text)
            echo "[$i/30] 상태: $STATUS"
            case "$STATUS" in
              RUNNING)     echo "배포 성공!"; exit 0 ;;
              *_FAILED)    echo "배포 실패: $STATUS"; exit 1 ;;
            esac
            sleep 30
          done
          echo "타임아웃 — AWS Console 에서 확인하세요"; exit 1

      - name: Get service URL
        id: url
        run: |
          ARN="${{ steps.deploy.outputs.service-arn }}"
          URL=$(aws apprunner describe-service \
            --service-arn "$ARN" \
            --query 'Service.ServiceUrl' --output text)
          echo "value=https://$URL" >> "$GITHUB_OUTPUT"
          echo "서비스 URL: https://$URL"

      - name: Summary
        run: |
          cat >> "$GITHUB_STEP_SUMMARY" <<EOF
          ## 배포 완료 ✅
          | 항목 | 값 |
          |------|-----|
          | 이미지 | \`${{ needs.build.outputs.image-uri }}\` |
          | 커밋 | \`${{ github.sha }}\` |
          | URL | ${{ steps.url.outputs.value }} |
          EOF

  # Job 4 (EC2 Scraper) — EC2 인스턴스 준비 후 추가 예정
